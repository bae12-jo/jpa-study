# QueryDSL
* Spring Boot + JPA + Spring Data JPA 로 해결하지 못하는 복잡한 쿼리와 동적쿼리를 해결할 수 있음
* 쿼리를 자바 코드로 작성할 수 있고 문법 오류를 컴파일 시점에 잡아준다.
* 쉬운 SQL 스타일의 문법을 사용한다.

```java
@Test
public void jpql(){
  String username = "kim";
  String query = "select m from Member m"
                  + "where m.username = :username"; // 문법 오류 있으나 실행을 해야 발견됨
  List<Member> result = em.createQuery(query, Member.class).getResultList();
}

@Test
public void querydsl(){
  String username = "kim";
  List<Member> result = queryFactory // 자바 컴파일러가 오타 잡아줌
                        .select(member)
                        .from(member)
                        .where(member.username.eq(username)) // 코드 자동 완성 도움 받을 수 있음
                        .fetch();
}
```

# JPQL vs QueryDSL
```java
@Test
public void startJPQL(){
  String qlString = "select m from Member m where m.username = :username"; // 파라미터 바인딩을 해줌
  Member findMember = em.createQuery(qlString, Member.class)
              .setParameter("username", "member1")
              .getSingleResult();
  Assertions.assertThat(findMember.getUsername().isEqualTo("member1"));
}

@Test
publci void startQuerydsl(){
  // (1) com.mysema.query.jpa.impl.JPAQuery 객체를 생성
  JPAQeuryFactory queryFactory = new JPAQueryFactory(em); // 엔티티 매니저를 생성자로 넘겨줘야함, thread-safe하므로 필드로 빼도 됨
  // (2) 쿼리 타입(Q)을 생성
  QMember = new QMember("m"); // 별칭을 붙여주는 것 (Q타입 내에 있는 기본 인스턴스 member를 이용해도 됨)
  Member findMember = queryFactory
                        .select(m)
                        .from(m)
                        .where(m.username.eq("member1")) // 파라미터 바인딩을 해주지 않아도 prepared statement로 자동 바인딩
                        .fetchOne();
   assertThat(findMember.getUsername().isEqualTo("member1"));

}
```

# 기본 Q 타입
* 프로젝트 > querydsl > entity > QMember.java 파일 안에 generated code 있음
* 하이버네이트에 `use_sql_comment: true` 옵션을 지정해주면 jpql이 실행된 쿼리를 콘솔에서 확인 가능
```java
// (1) 직접 지정 -- 같은 테이블을 join 하는 경우가 아니면 거의 쓸 일이 없음
QMember qMember = new QMember("m");

// (2) 기본 인스턴스 사용하기
QMember qMember = QMember.member;

// (3) 기본 인스턴스를 static으로 선언 -- 권장
import static 프로젝트명.domain.QMember.member;

@Test
publci void startQuerydsl(){
  Member findMember = queryFactory
                        .select(member)
                        .from(member)
                        .where(member.username.eq("member1"))
                        .fetchOne();
   assertThat(findMember.getUsername().isEqualTo("member1"));

}
```

# 검색 조건 쿼리
```java
@Test
public void searchAdnParam(){
  queryFactory
        .selectFrom(member)
        .where(member.usernae.eq("member1") 
          .and(member.age.eq(10)) // where 절에는 and가 아닌 or도 가능
        .fetchOne();
  assertThat(findMember.getUsername().isEqualTo("member1"));
}
```
* 검색 조건은 eq, not, in, notIn, between, goe, gt, loe, lt, linke, contains, startsWith
* JPQL에서 지원하는 모든 걸 사용 가능

```java
@Test
public void searchAndParam(){
  queryFactory
        .selectFrom(member)
        .where(
          member.usernmae.eq("member1"),
          member.age.eq(10), null // and를 쓰지 않고 여러개를 나열해도 무방, 중간이 null이 들어가면 무시되므로 동적 쿼리 작성 시 유리함
          )
        .fetchOne();
  assertThat(findMember.getUsername().isEqualTo("member1"));
}
```

# 결과 조회
http://querydsl.com/static/querydsl/4.4.0/apidocs/com/querydsl/core/Fetchable.html
* fetch(): 리스트 조회, 데이터 없으면 빈 리스트 반환 // list()
* fetchOne(): 단건 조회 // uniqueResult()
  * 결과 없으면 null
  * 결과가 둘 이상이면 com.querydsl.core.NonUniqueResultException
* fetchFirst(): limit(1).fetchOne() // singleResult()
* fetchResults(): 페이징 정보 포함, total count 쿼리 추가 실행 (decprecated)
* fetchCount(): count 쿼리로 변경해서 count 수 조회

http://querydsl.com/static/querydsl/3.0.0/apidocs//com/mysema/query/Projectable.html
* list(): 결과가 하나 이상일 때 사용, 결과가 없으면 빈 컬렉션 반환
* uniqueResult(): 조회 결과가 한건일 때 사용
  * 조회 결과가 없으면 null 반환
  * 하나 이상이면 com.mysema.query.NonUniqueResultException()
* singleResult(): 결과가 하나 이상이면 첫번째 데이터를 반환

# 정렬
```java
/**
* 회원 정렬 순서
* 1. 회원 나이 내림차순(desc)
* 2. 회원 이름 오름차순(asc)
* 단 2에서 회원 이름이 없으면 마지막에 출력(nulls last)
*/

@Test
public void sort(){
  em.persist(new Member(null, 100));
  em.persist(new Member("member5", 100));
  em.persist(new Member("member6", 100));
  
  queryFactory
      .selectFrom(member)
      .where(member.age.eq(100))
      .orderBy(member.age.desc(), member.username.asc().nullslast()) // nullsfirst() 옵션도 있음
      .fetch();
      
  Member member5 = result.get(0);
  Member member6 = result.get(1);
  Member memberNull = result.get(2);
  
  assertThat(member5.getUsername()).isEqualTo("member5");
  assertThat(member6.getUsername()).isEqualTo("member6");
  assertThat(memberNull.getUsername()).isNull();
}
```
# 페이징
```java
public void paing1(){
  queryFactory
      .selectFrom(member)
      .orderBy(member.username.desc())
      .offset(1)
      .limit(2)
      .fetch();
      
  assertThat(result.sie()).isEqualTo(2));
}
```
